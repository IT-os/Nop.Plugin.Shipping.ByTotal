@{
    Layout = "";

    var gridPageSize = EngineContext.Current.Resolve<Nop.Core.Domain.Common.AdminAreaSettings>().GridPageSize;
}
@model ShippingByTotalListModel
@using Nop.Plugin.Shipping.ByTotal.Models;
@using Nop.Web.Framework;
@using Telerik.Web.Mvc.UI;
@using Nop.Core.Infrastructure;
<table class="adminContent">
    <tr>
        <td>
            @(Html.Telerik().Grid<ShippingByTotalModel>()
                    .Name("shipping-bytotal-grid")
                    .DataKeys(keys => keys.Add(x => x.Id).RouteKey("Id"))
                    .DataBinding(dataBinding =>
                        dataBinding.Ajax()
                            .Select("RatesList", "ShippingByTotal", new RouteValueDictionary() { { "Namespaces", "Nop.Plugin.Shipping.ByTotal.Controllers" }, { "area", "" } })
                            .Update("RateUpdate", "ShippingByTotal", new RouteValueDictionary() { { "Namespaces", "Nop.Plugin.Shipping.ByTotal.Controllers" }, { "area", "" } })
                            .Delete("RateDelete", "ShippingByTotal", new RouteValueDictionary() { { "Namespaces", "Nop.Plugin.Shipping.ByTotal.Controllers" }, { "area", "" } })
                    )
                    .ClientEvents(events => events.OnError("Grid_onError"))
                    .Columns(columns =>
                    {
                        columns.Bound(x => x.StoreName).ReadOnly();
                        columns.Bound(x => x.CountryName).ReadOnly();
                        columns.Bound(x => x.StateProvinceName).ReadOnly();
                        columns.Bound(x => x.Zip);
                        columns.Bound(x => x.ShippingMethodName).ReadOnly();
                        columns.Bound(x => x.From);
                        columns.Bound(x => x.To);
                        columns.Bound(x => x.UsePercentage)
                            .ClientTemplate("<input type='checkbox' disabled='disabled' name='UsePercentage' <#=UsePercentage ? checked='checked' : ''#> />");
                        columns.Bound(x => x.ShippingChargePercentage);
                        columns.Bound(x => x.ShippingChargeAmount);
                        columns.Command(commands =>
                        {
                            commands.Edit();
                            commands.Delete();
                        }).Width(190);
                    })
                    .Editable(x => x.Mode(GridEditMode.InLine))
                    .Pageable(settings => settings.PageSize(gridPageSize).Position(GridPagerPosition.Both))
                    .EnableCustomBinding(true))
        </td>
    </tr>
</table>
<p>
</p>
<script type="text/javascript">
    function Grid_onError(e) {
        clearGrid(e.XMLHttpRequest.responseText);
        alert(e.XMLHttpRequest.responseText);
        e.preventDefault();
    }
    function clearGrid(message) {
        var grid = $('#shipping-bytotal-grid').data("tGrid");
        grid.total = 0;
        grid.dataBind(Array());
        $('#shipping-bytotal-grid').find('.t-no-data td').text(message);
    }
    $(function () {
        $("#@Html.FieldIdFor(model => model.AddCountryId)").change(function () {
            var selectedItem = $(this).val();
            var ddlStates = $("#@Html.FieldIdFor(model => model.AddStateProvinceId)")
            $.ajax({
                cache: false,
                type: "GET",
                url: "@(Url.Action("GetStatesByCountryId", "Country", new RouteValueDictionary() { { "area", "Admin" } }))",
                data: { "countryId": selectedItem, "addAsterisk": "true" },
                success: function (data) {
                    ddlStates.html('');
                    $.each(data, function (id, option) {
                        ddlStates.append($('<option></option>').val(option.id).html(option.name));
                    });
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    alert('@T("Plugins.Shipping.ByTotal.ManageShippingSettings.StatesFailed").Text');
                 }
            });
        });
    });
</script>
@using (Html.BeginForm())
{       
    <script type="text/javascript">
        $(function () {
            $("#@Html.FieldIdFor(model => model.AddUsePercentage)").click(toggleAddUsePercentage);
            toggleAddUsePercentage();
        });
        function toggleAddUsePercentage() {
            if ($('#@Html.FieldIdFor(model => model.AddUsePercentage)').is(':checked')) {
                $('#pnlAddShippingChargePercentage').show();
                $('#pnlAddShippingChargeAmount').hide();
            }
            else {
                $('#pnlAddShippingChargePercentage').hide();
                $('#pnlAddShippingChargeAmount').show();
            }
        }
        $(function () {
            $('#addshippingbytotalrecord').click(function () {
                $.ajax({
                    cache: false,
                    type: 'POST',
                    url: '@Url.RouteUrl("Plugin.Shipping.ByTotal.AddShippingRate")',
                    data: $(this.form).serialize(),
                    dataType: 'json',
                    success: function (data) {
                        if (data.Result == true) {
                            $("#shipping-bytotal-grid").data('tGrid').ajaxRequest();
                        }
                        else {
                            clearGrid(data.Message);
                            alert(data.Message);
                        }
                    },
                    error: function (xhr, ajaxOptions, thrownError) {
                        alert('@T("Plugins.Shipping.ByTotal.ManageShippingSettings.AddFailed").Text');
                    }
                });
                return false;
            });
        });

        $(function () {
            $('#savegeneralsettings').click(function () {
                $.ajax({
                    cache: false,
                    type: 'POST',
                    url: '@Url.RouteUrl("Plugin.Shipping.ByTotal.SaveGeneralSettings")',
                    data: $(this.form).serialize(),
                    dataType: 'json',
                    success: function (data) {
                        if (data.Result == false) {
                            clearGrid(data.Message);
                        }
                        alert(data.Message);
                    },
                    error: function (xhr, ajaxOptions, thrownError) {
                        alert('@T("Plugins.Shipping.ByTotal.ManageShippingSettings.AddFailed").Text');
                    }
                });
                return false;
            });
        });
    </script>
    <fieldset>
        <legend><span style="font-weight: 700">@T("Plugins.Shipping.ByTotal.AddNewRecordTitle")</span></legend>
        <table class="adminContent">
            <tr>
                <td class="adminTitle">
                    @Html.NopLabelFor(model => model.AddStoreId):
                </td>
                <td class="adminData">
                    @Html.DropDownListFor(model => model.AddStoreId, Model.AvailableStores)
                    @Html.ValidationMessageFor(model => model.AddStoreId)
                </td>
            </tr>
            <tr>
                <td class="adminTitle">
                    @Html.NopLabelFor(model => model.AddCountryId):
                </td>
                <td class="adminData">
                    @Html.DropDownListFor(model => model.AddCountryId, Model.AvailableCountries)
                    @Html.ValidationMessageFor(model => model.AddCountryId)
                </td>
            </tr>
            <tr>
                <td class="adminTitle">
                    @Html.NopLabelFor(model => model.AddStateProvinceId):
                </td>
                <td class="adminData">
                    @Html.DropDownListFor(model => model.AddStateProvinceId, Model.AvailableStates)
                    @Html.ValidationMessageFor(model => model.AddStateProvinceId)
                </td>
            </tr>
            <tr>
                <td class="adminTitle">
                    @Html.NopLabelFor(model => model.AddZip):
                </td>
                <td class="adminData">
                    @Html.EditorFor(model => model.AddZip)
                    @Html.ValidationMessageFor(model => model.AddZip)
                </td>
            </tr>
            <tr>
                <td class="adminTitle">
                    @Html.NopLabelFor(model => model.AddShippingMethodId):
                </td>
                <td class="adminData">
                    @Html.DropDownListFor(model => model.AddShippingMethodId, Model.AvailableShippingMethods)
                    @Html.ValidationMessageFor(model => model.AddShippingMethodId)
                </td>
            </tr>
            <tr>
                <td class="adminTitle">
                    @Html.NopLabelFor(model => model.AddFrom):
                </td>
                <td class="adminData">
                    @Html.EditorFor(model => model.AddFrom) [@Model.PrimaryStoreCurrencyCode]
                    @Html.ValidationMessageFor(model => model.AddFrom)
                </td>
            </tr>
            <tr>
                <td class="adminTitle">
                    @Html.NopLabelFor(model => model.AddTo):
                </td>
                <td class="adminData">
                    @Html.EditorFor(model => model.AddTo) [@Model.PrimaryStoreCurrencyCode]
                    @Html.ValidationMessageFor(model => model.AddTo)
                </td>
            </tr>
            <tr>
                <td class="adminTitle">
                    @Html.NopLabelFor(model => model.AddUsePercentage):
                </td>
                <td class="adminData">
                    @Html.EditorFor(model => model.AddUsePercentage)
                    @Html.ValidationMessageFor(model => model.AddUsePercentage)
                </td>
            </tr>
            <tr id="pnlAddShippingChargePercentage">
                <td class="adminTitle">
                    @Html.NopLabelFor(model => model.AddShippingChargePercentage):
                </td>
                <td class="adminData">
                    @Html.EditorFor(model => model.AddShippingChargePercentage)
                    @Html.ValidationMessageFor(model => model.AddShippingChargePercentage)
                </td>
            </tr>
            <tr id="pnlAddShippingChargeAmount">
                <td class="adminTitle">
                    @Html.NopLabelFor(model => model.AddShippingChargeAmount):
                </td>
                <td class="adminData">
                    @Html.EditorFor(model => model.AddShippingChargeAmount) [@Model.PrimaryStoreCurrencyCode]
                    @Html.ValidationMessageFor(model => model.AddShippingChargeAmount)
                </td>
            </tr>
            <tr>
                <td colspan="2">
                    <button type="button" id="addshippingbytotalrecord" class="t-button">
                        @T("Admin.Common.AddNew")</button>
                </td>
            </tr>
        </table>
    </fieldset>
    <br />
    <hr />
    <br />
    <fieldset>
        <legend><span style="font-weight: 700">@T("Plugins.Shipping.ByTotal.SettingsTitle")</span></legend>
        <table class="adminContent">
            <tr>
                <td class="adminTitle">
                    @Html.NopLabelFor(model => model.LimitMethodsToCreated):
                </td>
                <td class="adminData">
                    @Html.EditorFor(model => model.LimitMethodsToCreated)
                    @Html.ValidationMessageFor(model => model.LimitMethodsToCreated)
                </td>
            </tr>
            <tr>
                <td colspan="2">
                    <button type="button" id="savegeneralsettings" class="t-button">
                        @T("Admin.Common.Save")</button>
                </td>
            </tr>
        </table>
    </fieldset>
}